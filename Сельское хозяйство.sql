-- Таблица видов собственности
CREATE TABLE Виды_собственности (
    ID_вида INT PRIMARY KEY IDENTITY(1,1),
    Название_вида NVARCHAR(100) NOT NULL UNIQUE
);

-- Таблица единиц измерения
CREATE TABLE Единицы_измерения (
    ID_единицы INT PRIMARY KEY IDENTITY(1,1),
    Название_единицы NVARCHAR(20) NOT NULL UNIQUE,
    Сокращение NVARCHAR(10) NOT NULL UNIQUE
);

-- Таблица продукции
CREATE TABLE Продукция (
    ID_продукции INT PRIMARY KEY IDENTITY(1,1),
    Название_продукции NVARCHAR(100) NOT NULL,
    ID_единицы INT NOT NULL,
    Закупочная_цена DECIMAL(12,2) NOT NULL CHECK (Закупочная_цена > 0),
    FOREIGN KEY (ID_единицы) REFERENCES Единицы_измерения(ID_единицы)
);

-- Таблица предприятий
CREATE TABLE Предприятия (
    ID_предприятия INT PRIMARY KEY IDENTITY(1,1),
    Наименование NVARCHAR(200) NOT NULL,
    Дата_регистрации DATE NOT NULL,
    ID_вида_собственности INT NOT NULL,
    Число_работников INT NOT NULL CHECK (Число_работников > 0),
    Основной_вид_продукции NVARCHAR(100),
    Передовое_в_технологиях BIT DEFAULT 0,
    Прибыль DECIMAL(12,2),
    Примечание NVARCHAR(500),
    FOREIGN KEY (ID_вида_собственности) REFERENCES Виды_собственности(ID_вида)
);

-- Таблица поставок
CREATE TABLE Поставки (
    ID_поставки INT PRIMARY KEY IDENTITY(1,1),
    ID_предприятия INT NOT NULL,
    ID_продукции INT NOT NULL,
    Дата_поставки DATE NOT NULL,
    Объем DECIMAL(12,3) NOT NULL CHECK (Объем > 0),
    Себестоимость DECIMAL(12,2) NOT NULL CHECK (Себестоимость > 0),
    FOREIGN KEY (ID_предприятия) REFERENCES Предприятия(ID_предприятия),
    FOREIGN KEY (ID_продукции) REFERENCES Продукция(ID_продукции)
);

-- Заполнение видов собственности
INSERT INTO Виды_собственности (Название_вида) VALUES
('Государственная'),
('Частная'),
('Кооперативная'),
('Акционерное общество'),
('Фермерское хозяйство');

-- Заполнение единиц измерения
INSERT INTO Единицы_измерения (Название_единицы, Сокращение) VALUES
('Килограмм', 'кг'),
('Тонна', 'т'),
('Литр', 'л'),
('Штука', 'шт'),
('Гектолитр', 'гл');

-- Заполнение продукции
INSERT INTO Продукция (Название_продукции, ID_единицы, Закупочная_цена) VALUES
('Пшеница', 2, 15000.00),
('Банан', 1, 120.00),
('Молоко', 3, 65.00),
('Яблоки', 1, 85.00),
('Картофель', 1, 45.00),
('Говядина', 1, 350.00);

-- Заполнение предприятий
INSERT INTO Предприятия (Наименование, Дата_регистрации, ID_вида_собственности, Число_работников, Основной_вид_продукции, Передовое_в_технологиях, Прибыль, Примечание) VALUES
('Заря', '1995-05-15', 2, 120, 'Пшеница', 1, 2500000.00, 'Лидер по урожайности в регионе'),
('КАМАЗ', '2000-08-20', 1, 350, 'Картофель', 0, -500000.00, 'Убыточное в текущем году'),
('Фруктовый рай', '2010-03-10', 5, 45, 'Банан', 1, 1200000.00, 'Специализируется на экзотических фруктах'),
('Молочные реки', '2005-11-25', 3, 80, 'Молоко', 0, 800000.00, 'Экологически чистая продукция'),
('Яблочный край', '2015-07-05', 4, 60, 'Яблоки', 1, 950000.00, 'Использует современные технологии хранения');

-- Заполнение поставок
INSERT INTO Поставки (ID_предприятия, ID_продукции, Дата_поставки, Объем, Себестоимость) VALUES
(1, 1, '2023-01-15', 100.500, 14000.00),
(2, 5, '2023-02-10', 500.000, 40.00),
(3, 2, '2023-03-05', 2000.000, 100.00),
(4, 3, '2023-01-20', 1500.000, 50.00),
(5, 4, '2023-02-15', 800.000, 70.00),
(3, 2, '2023-04-01', 2500.000, 95.00),
(1, 1, '2023-03-20', 120.750, 14200.00),
(4, 3, '2023-04-05', 1800.000, 48.00),
(5, 4, '2023-03-25', 950.000, 68.00),
(2, 5, '2023-04-10', 600.000, 42.00);

SELECT 
    Наименование AS Предприятие,
    Прибыль,
    Число_работников,
    Основной_вид_продукции
FROM 
    Предприятия
WHERE 
    Прибыль < 0
    AND YEAR(GETDATE()) = YEAR(Дата_регистрации);

	SELECT 
    Наименование AS Предприятие,
    Прибыль / Число_работников AS Доход_на_работника
FROM 
    Предприятия
WHERE 
    Наименование = 'КАМАЗ';
SELECT 
    Основной_вид_продукции,
    STRING_AGG(Наименование, ', ') WITHIN GROUP (ORDER BY Наименование) AS Передовые_предприятия
FROM 
    Предприятия
WHERE 
    Передовое_в_технологиях = 1
GROUP BY 
    Основной_вид_продукции;