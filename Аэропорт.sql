-- Таблица типов самолетов
CREATE TABLE Типы_самолетов (
    ID_типа INT PRIMARY KEY IDENTITY(1,1),
    Название_типа NVARCHAR(50) NOT NULL UNIQUE,
    Число_мест INT NOT NULL CHECK (Число_мест > 0),
    Скорость_полета INT NOT NULL CHECK (Скорость_полета > 0) -- км/ч
);

-- Таблица маршрутов
CREATE TABLE Маршруты (
    ID_маршрута INT PRIMARY KEY IDENTITY(1,1),
    Номер_маршрута NVARCHAR(20) NOT NULL UNIQUE,
    Пункт_вылета NVARCHAR(100) NOT NULL,
    Пункт_назначения NVARCHAR(100) NOT NULL,
    Расстояние INT NOT NULL CHECK (Расстояние > 0) -- км
);

-- Таблица самолетов
CREATE TABLE Самолеты (
    ID_самолета INT PRIMARY KEY IDENTITY(1,1),
    Номер_самолета NVARCHAR(20) NOT NULL UNIQUE,
    ID_типа INT NOT NULL,
    FOREIGN KEY (ID_типа) REFERENCES Типы_самолетов(ID_типа)
);

-- Таблица рейсов
CREATE TABLE Рейсы (
    ID_рейса INT PRIMARY KEY IDENTITY(1,1),
    ID_самолета INT NOT NULL,
    ID_маршрута INT NOT NULL,
    Дата_вылета DATETIME NOT NULL,
    Дата_прилета DATETIME NOT NULL,
    Проданные_билеты INT NOT NULL CHECK (Проданные_билеты >= 0),
    FOREIGN KEY (ID_самолета) REFERENCES Самолеты(ID_самолета),
    FOREIGN KEY (ID_маршрута) REFERENCES Маршруты(ID_маршрута),
    CHECK (Дата_прилета > Дата_вылета)
);

-- Заполнение типов самолетов
INSERT INTO Типы_самолетов (Название_типа, Число_мест, Скорость_полета) VALUES
('Boeing 737', 180, 850),
('Airbus A320', 150, 840),
('Ту-154', 168, 900),
('Embraer 190', 100, 890),
('Boeing 777', 350, 905);

-- Заполнение маршрутов
INSERT INTO Маршруты (Номер_маршрута, Пункт_вылета, Пункт_назначения, Расстояние) VALUES
('SU-100', 'Москва', 'Санкт-Петербург', 650),
('SU-200', 'Киев', 'Львов', 540),
('SU-300', 'Чугуев', 'Мерефа', 120),
('SU-400', 'Париж', 'Лондон', 340),
('SU-500', 'Нью-Йорк', 'Лос-Анджелес', 4000);

-- Заполнение самолетов
INSERT INTO Самолеты (Номер_самолета, ID_типа) VALUES
('RA-73851', 1),
('RA-73852', 1),
('VP-BLX', 2),
('RA-85732', 3),
('RA-85733', 3),
('RA-85734', 3),
('VP-BON', 4),
('VQ-BGV', 5);

-- Заполнение рейсов
INSERT INTO Рейсы (ID_самолета, ID_маршрута, Дата_вылета, Дата_прилета, Проданные_билеты) VALUES
(1, 1, '2023-01-15 08:00', '2023-01-15 09:30', 150),
(2, 1, '2023-01-15 12:00', '2023-01-15 13:30', 170),
(3, 2, '2023-01-16 07:00', '2023-01-16 08:30', 120),
(4, 3, '2023-01-17 09:00', '2023-01-17 09:30', 100),
(5, 3, '2023-01-18 09:00', '2023-01-18 09:30', 140),
(6, 3, '2023-01-19 09:00', '2023-01-19 09:30', 50),
(7, 4, '2023-01-20 10:00', '2023-01-20 11:00', 80),
(8, 5, '2023-01-21 15:00', '2023-01-21 19:30', 320),
(4, 3, '2023-02-01 09:00', '2023-02-01 09:30', 130),
(4, 3, '2011-12-31 10:00', '2011-12-31 10:30', 120); -- Рейс №870 (пример)

SELECT 
    AVG(DATEDIFF(MINUTE, р.Дата_вылета, р.Дата_прилета)) AS Среднее_время_полета_минуты,
    AVG(м.Расстояние * 60.0 / тс.Скорость_полета) AS Расчетное_время_полета_минуты
FROM 
    Рейсы р
JOIN 
    Самолеты с ON р.ID_самолета = с.ID_самолета
JOIN 
    Типы_самолетов тс ON с.ID_типа = тс.ID_типа
JOIN 
    Маршруты м ON р.ID_маршрута = м.ID_маршрута
WHERE 
    тс.Название_типа = 'Ту-154'
    AND м.Пункт_вылета = 'Чугуев'
    AND м.Пункт_назначения = 'Мерефа';

	WITH Самые_популярные_марки AS (
    SELECT 
        тс.Название_типа,
        COUNT(*) AS Количество_рейсов,
        RANK() OVER (ORDER BY COUNT(*) DESC) AS Ранг
    FROM 
        Рейсы р
    JOIN 
        Самолеты с ON р.ID_самолета = с.ID_самолета
    JOIN 
        Типы_самолетов тс ON с.ID_типа = тс.ID_типа
    GROUP BY 
        тс.Название_типа
)
SELECT 
    Название_типа AS Марка_самолета,
    Количество_рейсов
FROM 
    Самые_популярные_марки
WHERE 
    Ранг = 1;

SELECT 
    р.ID_рейса AS Номер_рейса,
    м.Номер_маршрута,
    с.Номер_самолета,
    тс.Название_типа,
    тс.Число_мест - р.Проданные_билеты AS Свободные_места
FROM 
    Рейсы р
JOIN 
    Самолеты с ON р.ID_самолета = с.ID_самолета
JOIN 
    Типы_самолетов тс ON с.ID_типа = тс.ID_типа
JOIN 
    Маршруты м ON р.ID_маршрута = м.ID_маршрута
WHERE 
    м.Номер_маршрута = 'SU-300' -- Предполагаем, что это рейс №870
    AND CAST(р.Дата_вылета AS DATE) = '2011-12-31';