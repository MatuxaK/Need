SELECT TOP 1
    м.ФИО AS Механик,
    COUNT(*) AS Количество_ремонтов
FROM 
    Механики м
JOIN 
    Назначения_механиков нм ON м.ID_механика = нм.ID_механика
JOIN 
    Наряды н ON нм.ID_наряда = н.ID_наряда
JOIN 
    Автомобили а ON н.ID_автомобиля = а.ID_автомобиля
WHERE 
    а.Год_выпуска < 1945
GROUP BY 
    м.ФИО
ORDER BY 
    Количество_ремонтов DESC;

SELECT 
    а.Номер_авто,
    н.Дата_выдачи,
    н.Плановая_дата_окончания,
    н.Реальная_дата_окончания,
    DATEDIFF(day, н.Плановая_дата_окончания, н.Реальная_дата_окончания) AS Дней_задержки
FROM 
    Наряды н
JOIN 
    Автомобили а ON н.ID_автомобиля = а.ID_автомобиля
WHERE 
    а.Марка = 'Mercedes-Benz' AND а.Модель = '600'
    AND н.Реальная_дата_окончания > н.Плановая_дата_окончания;

SELECT 
    в.ФИО AS Владелец,
    м.ФИО AS Механик
FROM 
    Владельцы в
JOIN 
    Автомобили а ON в.ID_владельца = а.ID_владельца
JOIN 
    Наряды н ON а.ID_автомобиля = н.ID_автомобиля
JOIN 
    Назначения_механиков нм ON н.ID_наряда = нм.ID_наряда
JOIN 
    Механики м ON нм.ID_механика = м.ID_механика
GROUP BY 
    в.ФИО, м.ФИО
HAVING 
    COUNT(DISTINCT н.ID_наряда) = (
        SELECT COUNT(*) 
        FROM Наряды н2 
        JOIN Автомобили а2 ON н2.ID_автомобиля = а2.ID_автомобиля 
        WHERE а2.ID_владельца = в.ID_владельца
    );

WITH РазрядыПоКатегориям AS (
    SELECT 
        кр.Название_категории,
        м.Разряд,
        COUNT(*) AS Количество,
        RANK() OVER (PARTITION BY кр.Название_категории ORDER BY COUNT(*) DESC) AS Ранг
    FROM 
        Категории_работ кр
    JOIN 
        Наряды н ON кр.ID_категории = н.ID_категории
    JOIN 
        Назначения_механиков нм ON н.ID_наряда = нм.ID_наряда
    JOIN 
        Механики м ON нм.ID_механика = м.ID_механика
    GROUP BY 
        кр.Название_категории, м.Разряд
)
SELECT 
    Название_категории AS Категория_работ,
    Разряд
FROM 
    РазрядыПоКатегориям
WHERE 
    Ранг = 1;