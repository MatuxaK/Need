-- Таблица спортивных разрядов
CREATE TABLE Разряды (
    ID_разряда INT PRIMARY KEY IDENTITY(1,1),
    Название_разряда NVARCHAR(50) NOT NULL UNIQUE
);

-- Таблица уровней турниров
CREATE TABLE Уровни_турниров (
    ID_уровня INT PRIMARY KEY IDENTITY(1,1),
    Название_уровня NVARCHAR(50) NOT NULL UNIQUE
);

-- Таблица шахматистов
CREATE TABLE Шахматисты (
    ID_шахматиста INT PRIMARY KEY IDENTITY(1,1),
    Фамилия NVARCHAR(50) NOT NULL,
    Имя NVARCHAR(50) NOT NULL,
    Дата_рождения DATE NOT NULL,
    Страна NVARCHAR(50) NOT NULL,
    ID_разряда INT,
    Участвовал_в_чемпионате_мира BIT DEFAULT 0,
    Рейтинг INT CHECK (Рейтинг >= 0),
    FOREIGN KEY (ID_разряда) REFERENCES Разряды(ID_разряда)
);

-- Таблица турниров
CREATE TABLE Турниры (
    ID_турнира INT PRIMARY KEY IDENTITY(1,1),
    Название_турнира NVARCHAR(100) NOT NULL,
    Страна NVARCHAR(50) NOT NULL,
    Город NVARCHAR(50) NOT NULL,
    Дата_начала DATE NOT NULL,
    Дата_окончания DATE NOT NULL,
    ID_уровня INT NOT NULL,
    FOREIGN KEY (ID_уровня) REFERENCES Уровни_турниров(ID_уровня),
    CHECK (Дата_окончания >= Дата_начала)
);

-- Таблица участия в турнирах
CREATE TABLE Участие_в_турнирах (
    ID_участия INT PRIMARY KEY IDENTITY(1,1),
    ID_турнира INT NOT NULL,
    ID_шахматиста INT NOT NULL,
    Стартовый_номер INT NOT NULL,
    Занятое_место INT NOT NULL CHECK (Занятое_место > 0),
    FOREIGN KEY (ID_турнира) REFERENCES Турниры(ID_турнира),
    FOREIGN KEY (ID_шахматиста) REFERENCES Шахматисты(ID_шахматиста),
    UNIQUE (ID_турнира, ID_шахматиста),
    UNIQUE (ID_турнира, Стартовый_номер)
);
-- Заполнение разрядов
INSERT INTO Разряды (Название_разряда) VALUES 
('Кандидат в мастера спорта'),
('Мастер спорта'),
('Гроссмейстер'),
('Международный гроссмейстер');

-- Заполнение уровней турниров
INSERT INTO Уровни_турниров (Название_уровня) VALUES 
('Локальный'),
('Национальный'),
('Международный'),
('Гран-при'),
('Чемпионат мира');

-- Заполнение шахматистов
INSERT INTO Шахматисты (Фамилия, Имя, Дата_рождения, Страна, ID_разряда, Участвовал_в_чемпионате_мира, Рейтинг) VALUES
('Карлсен', 'Магнус', '1990-11-30', 'Норвегия', 4, 1, 2865),
('Каруана', 'Фабиано', '1992-07-30', 'США', 4, 1, 2782),
('Непомнящий', 'Ян', '1990-07-14', 'Россия', 4, 1, 2773),
('Дин', 'Лижэнь', '1992-10-24', 'Китай', 4, 1, 2780),
('Гири', 'Аниш', '1994-06-28', 'Нидерланды', 4, 1, 2760),
('Свидлер', 'Пётр', '1976-06-17', 'Россия', 4, 0, 2720),
('Накамура', 'Хикару', '1987-12-09', 'США', 4, 0, 2768),
('Аронян', 'Левон', '1982-10-06', 'Армения', 4, 1, 2750);

-- Заполнение турниров
INSERT INTO Турниры (Название_турнира, Страна, Город, Дата_начала, Дата_окончания, ID_уровня) VALUES
('Чемпионат мира', 'Казахстан', 'Астана', '2023-04-07', '2023-04-30', 5),
('Турнир претендентов', 'Испания', 'Мадрид', '2022-06-16', '2022-07-05', 4),
('Wijk aan Zee', 'Нидерланды', 'Вейк-ан-Зее', '2023-01-13', '2023-01-29', 3),
('Sinquefield Cup', 'США', 'Сент-Луис', '2022-09-01', '2022-09-12', 3),
('Чемпионат России', 'Россия', 'Москва', '2022-12-01', '2022-12-15', 2);

-- Заполнение участия в турнирах
INSERT INTO Участие_в_турнирах (ID_турнира, ID_шахматиста, Стартовый_номер, Занятое_место) VALUES
(1, 1, 1, 1), (1, 2, 2, 2), (1, 3, 3, 3), (1, 4, 4, 4),
(2, 2, 1, 1), (2, 3, 2, 2), (2, 4, 3, 3), (2, 5, 4, 4),
(3, 1, 1, 1), (3, 5, 2, 2), (3, 6, 3, 3), (3, 7, 4, 4),
(4, 2, 1, 1), (4, 7, 2, 2), (4, 8, 3, 3), (4, 1, 4, 4),
(5, 3, 1, 1), (5, 6, 2, 2), (5, 8, 3, 3);
SELECT TOP 1
    т.Название_турнира,
    AVG(ш.Рейтинг) AS Средний_рейтинг
FROM 
    Турниры т
JOIN 
    Участие_в_турнирах у ON т.ID_турнира = у.ID_турнира
JOIN 
    Шахматисты ш ON у.ID_шахматиста = ш.ID_шахматиста
GROUP BY 
    т.ID_турнира, т.Название_турнира
ORDER BY 
    Средний_рейтинг DESC;

	SELECT 
    т.Название_турнира,
    т.Страна AS Страна_турнира
FROM 
    Турниры т
WHERE NOT EXISTS (
    SELECT 1
    FROM Участие_в_турнирах у
    JOIN Шахматисты ш ON у.ID_шахматиста = ш.ID_шахматиста
    WHERE у.ID_турнира = т.ID_турнира
    AND у.Занятое_место <= 3 -- призовые места
    AND ш.Страна != т.Страна -- не из страны турнира
)
AND EXISTS (
    SELECT 1
    FROM Участие_в_турнирах у
    WHERE у.ID_турнира = т.ID_турнира
    AND у.Занятое_место <= 3
);

SELECT 
    ш.Фамилия,
    ш.Имя,
    COUNT(*) AS Количество_призовых_мест
FROM 
    Шахматисты ш
JOIN 
    Участие_в_турнирах у ON ш.ID_шахматиста = у.ID_шахматиста
JOIN 
    Турниры т ON у.ID_турнира = т.ID_турнира
WHERE 
    у.Занятое_место <= 3
    AND YEAR(т.Дата_начала) = 2011
GROUP BY 
    ш.ID_шахматиста, ш.Фамилия, ш.Имя
HAVING 
    COUNT(*) >= 3;

	WITH РейтингиНаТурнирах AS (
    SELECT 
        у.ID_турнира,
        у.ID_шахматиста,
        ш.Рейтинг,
        у.Занятое_место,
        MAX(ш.Рейтинг) OVER (PARTITION BY у.ID_турнира) AS Макс_рейтинг_турнира
    FROM 
        Участие_в_турнирах у
    JOIN 
        Шахматисты ш ON у.ID_шахматиста = ш.ID_шахматиста
)
SELECT DISTINCT
    т.Название_турнира,
    т.Страна,
    т.Город
FROM 
    Турниры т
JOIN 
    РейтингиНаТурнирах р ON т.ID_турнира = р.ID_турнира
WHERE 
    р.Рейтинг = р.Макс_рейтинг_турнира
    AND р.Занятое_место = (
        SELECT MAX(у.Занятое_место) 
        FROM Участие_в_турнирах у 
        WHERE у.ID_турнира = т.ID_турнира
    );